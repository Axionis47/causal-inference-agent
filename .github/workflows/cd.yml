name: Continuous Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGION: us-central1
  REGISTRY: gcr.io

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    outputs:
      backend_url: ${{ steps.deploy-backend.outputs.backend_url }}
      frontend_url: ${{ steps.deploy-frontend.outputs.frontend_url }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Resolve project ID
        id: gcp
        run: echo "project_id=$(gcloud config get-value project)" >> "$GITHUB_OUTPUT"

      - name: Configure Docker
        run: gcloud auth configure-docker gcr.io

      - name: Build and push backend
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ steps.gcp.outputs.project_id }}/causal-backend:${{ github.sha }} ./backend
          docker push ${{ env.REGISTRY }}/${{ steps.gcp.outputs.project_id }}/causal-backend:${{ github.sha }}

      - name: Build and push frontend
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ steps.gcp.outputs.project_id }}/causal-frontend:${{ github.sha }} ./frontend
          docker push ${{ env.REGISTRY }}/${{ steps.gcp.outputs.project_id }}/causal-frontend:${{ github.sha }}

      - name: Deploy backend to Cloud Run
        id: deploy-backend
        run: |
          # Clear any previous secret-type env vars before setting as plain env vars
          gcloud run services update causal-backend-staging \
            --region ${{ env.REGION }} \
            --remove-secrets KAGGLE_USERNAME,API_KEY 2>/dev/null || true
          BACKEND_URL=$(gcloud run deploy causal-backend-staging \
            --image ${{ env.REGISTRY }}/${{ steps.gcp.outputs.project_id }}/causal-backend:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "ENVIRONMENT=staging,SSE_ENABLED=true,KAGGLE_USERNAME=${{ secrets.KAGGLE_USERNAME }},API_KEY=${{ secrets.API_KEY }}" \
            --set-secrets CLAUDE_API_KEY=anthropic-api-key:latest,KAGGLE_KEY=kaggle-key:latest \
            --format='value(status.url)')
          echo "backend_url=$BACKEND_URL" >> "$GITHUB_OUTPUT"
          echo "Backend deployed to: $BACKEND_URL"

      - name: Deploy frontend to Cloud Run
        id: deploy-frontend
        run: |
          BACKEND_URL="${{ steps.deploy-backend.outputs.backend_url }}"
          FRONTEND_URL=$(gcloud run deploy causal-frontend-staging \
            --image ${{ env.REGISTRY }}/${{ steps.gcp.outputs.project_id }}/causal-frontend:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars API_URL=$BACKEND_URL \
            --format='value(status.url)')
          echo "frontend_url=$FRONTEND_URL" >> "$GITHUB_OUTPUT"
          echo "Frontend deployed to: $FRONTEND_URL"

      - name: Update backend CORS with frontend URL
        run: |
          FRONTEND_URL="${{ steps.deploy-frontend.outputs.frontend_url }}"
          gcloud run services update causal-backend-staging \
            --region ${{ env.REGION }} \
            --update-env-vars "^##^CORS_ORIGINS=[\"$FRONTEND_URL\",\"http://localhost:3000\",\"http://localhost:5173\"]"

      - name: Validate staging deployment
        run: |
          BACKEND_URL="${{ steps.deploy-backend.outputs.backend_url }}"
          echo "Checking backend health..."
          curl -sf "$BACKEND_URL/health" || exit 1
          echo "Backend is healthy!"

  benchmark-validation:
    name: Benchmark Validation (Optional)
    runs-on: ubuntu-latest
    needs: deploy-staging
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install pytest pytest-asyncio pytest-timeout

      - name: Run benchmark tests
        env:
          CLAUDE_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cd backend
          python -m pytest benchmarks/runners/test_benchmark.py -v --timeout=600 -x -k "not test_run_single_ihdp and not test_run_all_benchmarks"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Resolve project ID
        id: gcp
        run: echo "project_id=$(gcloud config get-value project)" >> "$GITHUB_OUTPUT"

      - name: Configure Docker
        run: gcloud auth configure-docker gcr.io

      - name: Deploy backend to Production
        id: deploy-backend-prod
        run: |
          # Clear any previous secret-type env vars before setting as plain env vars
          gcloud run services update causal-backend \
            --region ${{ env.REGION }} \
            --remove-secrets KAGGLE_USERNAME,API_KEY 2>/dev/null || true
          BACKEND_URL=$(gcloud run deploy causal-backend \
            --image ${{ env.REGISTRY }}/${{ steps.gcp.outputs.project_id }}/causal-backend:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --min-instances 1 \
            --max-instances 10 \
            --set-env-vars "ENVIRONMENT=production,SSE_ENABLED=true,USE_FIRESTORE=true,KAGGLE_USERNAME=${{ secrets.KAGGLE_USERNAME }},API_KEY=${{ secrets.API_KEY }}" \
            --set-secrets CLAUDE_API_KEY=anthropic-api-key:latest,KAGGLE_KEY=kaggle-key:latest \
            --format='value(status.url)')
          echo "backend_url=$BACKEND_URL" >> "$GITHUB_OUTPUT"
          echo "Backend deployed to: $BACKEND_URL"

      - name: Deploy frontend to Production
        id: deploy-frontend-prod
        run: |
          BACKEND_URL="${{ steps.deploy-backend-prod.outputs.backend_url }}"
          FRONTEND_URL=$(gcloud run deploy causal-frontend \
            --image ${{ env.REGISTRY }}/${{ steps.gcp.outputs.project_id }}/causal-frontend:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --min-instances 1 \
            --set-env-vars API_URL=$BACKEND_URL \
            --format='value(status.url)')
          echo "frontend_url=$FRONTEND_URL" >> "$GITHUB_OUTPUT"
          echo "Frontend deployed to: $FRONTEND_URL"

      - name: Update backend CORS with frontend URL
        run: |
          FRONTEND_URL="${{ steps.deploy-frontend-prod.outputs.frontend_url }}"
          gcloud run services update causal-backend \
            --region ${{ env.REGION }} \
            --update-env-vars "^##^CORS_ORIGINS=[\"$FRONTEND_URL\",\"http://localhost:3000\",\"http://localhost:5173\"]"

      - name: Validate production deployment
        run: |
          BACKEND_URL="${{ steps.deploy-backend-prod.outputs.backend_url }}"
          echo "Checking production backend health..."
          curl -sf "$BACKEND_URL/health" || exit 1
          echo "Production backend is healthy!"
